

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Tutorial: Diffusion &mdash; dafi  documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
        <script type="text/javascript" src="_static/jquery.js"></script>
        <script type="text/javascript" src="_static/underscore.js"></script>
        <script type="text/javascript" src="_static/doctools.js"></script>
        <script type="text/javascript" src="_static/language_data.js"></script>
        <script async="async" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    
    <script type="text/javascript" src="_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Source Code" href="source_code.html" />
    <link rel="prev" title="Tutorial: Lorenz63" href="tutorial_lorenz.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="index.html" class="icon icon-home"> dafi
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="install.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="theory.html">Theory</a></li>
<li class="toctree-l1"><a class="reference internal" href="tutorial_lorenz.html">Tutorial: Lorenz63</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Tutorial: Diffusion</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#problem-description">Problem Description</a></li>
<li class="toctree-l2"><a class="reference internal" href="#field-representation">Field Representation</a></li>
<li class="toctree-l2"><a class="reference internal" href="#building-the-dynamic-model">Building the Dynamic Model</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#diffusion-model-files">Diffusion Model Files</a></li>
<li class="toctree-l3"><a class="reference internal" href="#init">__init__</a></li>
<li class="toctree-l3"><a class="reference internal" href="#synthetic-observations">synthetic observations</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#running-the-code">Running the code</a></li>
<li class="toctree-l2"><a class="reference internal" href="#references">References</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="source_code.html">Source Code</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">dafi</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="index.html">Docs</a> &raquo;</li>
        
      <li>Tutorial: Diffusion</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="_sources/tutorial_diffusion.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="tutorial-diffusion">
<h1>Tutorial: Diffusion<a class="headerlink" href="#tutorial-diffusion" title="Permalink to this headline">¶</a></h1>
<p>This tutorial provides the instructions to run the code for one dimension field inversion problem based on heat diffusion equation using the provided Tutorials (located in the ‘’$tutorials/diffusion’’).</p>
<div class="section" id="problem-description">
<h2>Problem Description<a class="headerlink" href="#problem-description" title="Permalink to this headline">¶</a></h2>
<p>The heat diffusion equation for a rod can be expressed as following:</p>
<div class="math notranslate nohighlight">
\[- \frac{d}{dx}(\mu \frac{du}{dx}) = f(x) \qquad x \in [0, 5]\]</div>
<p>where <span class="math notranslate nohighlight">\(\mu\)</span> are unknown thermal diffusivity to be infered varying with the location in the rod, <span class="math notranslate nohighlight">\(u\)</span> is the temperature and <span class="math notranslate nohighlight">\(f(x)\)</span> is external heat source term which in this case is simplfied as <span class="math notranslate nohighlight">\(f(x) = sin( 0.4 \pi x)\)</span>.</p>
<p>To solve the diffusion equation, the central difference scheme is used. The finite difference method is applied to replace the partial derivation of diffusivity in equation.</p>
<div class="math notranslate nohighlight">
\[- \frac{d}{dx}(\mu \frac{du}{dx}) = -\frac{d\mu}{dx} \frac{du}{dx}+\mu\frac{du^2}{d^2x}=f(x)\]</div>
<p>with</p>
<div class="math notranslate nohighlight">
\[\frac{du_i}{dx} = \frac{u_{i+1}-u_{i-1}}{2\delta x}\]</div>
<div class="math notranslate nohighlight">
\[\frac{du^2}{d^2x} = \frac{u_{i+1}-2u_i+u_{i-1}}{\Delta x^2}\]</div>
<p>The difference scheme can be expressed as below:</p>
<div class="math notranslate nohighlight">
\[(\frac{1}{2\Delta x}\frac{\mu_{i+1}-\mu_{i}}{\Delta x} + \frac{\mu_i}{\Delta x^2})u_{i+1} + (-\frac{2\mu_i}{\Delta x^2})\mu_i+(-\frac{1}{2\Delta x}\frac{\mu_{i+1}-\mu_{i}}{\Delta x} + \frac{\mu_i}{\Delta x^2}) u_{i-1} = f(x_i)\]</div>
<p>The spatial interval is 0.1, and the length of rod is 5. Thus the dimension of state varibles is 50.</p>
</div>
<div class="section" id="field-representation">
<h2>Field Representation<a class="headerlink" href="#field-representation" title="Permalink to this headline">¶</a></h2>
<p>Field inverse problem is of great interest in reality, however to infer a field based on sparse observation also increases the ill-poseness of the problem. The high dimensionalty comparing to the limited number of samples will lead to the ununiqueness of the solution.</p>
<p>Therefore it is necessary to reduce the dimensionality to indirectly characterize the field. To represent the field, the most widely used method is Karhunen-Loeve expansion which is commonly used to represent the stochatic process through a combination of a set of orthogonal functions. In this case, the method is leveraged to reduce the dimension of state varibles.</p>
<p>The field of diffusivity is reconstructed by a set of deterministic functions with corresponding random variables:</p>
<div class="math notranslate nohighlight">
\[\mu(x) = \sum_{i=1}^m \omega_i \phi_i(x)\]</div>
<p>where the subscript is the <span class="math notranslate nohighlight">\(i\)</span>omega_i`, is a random variable and <span class="math notranslate nohighlight">\(\phi_i(x)\)</span> is the deterministic basis set.</p>
<p>The prior of <span class="math notranslate nohighlight">\(\mu(x)\)</span> is regarded as zero-mean Gaussian random fields, where the covariance of two different location (kernel function) is described as:</p>
<div class="math notranslate nohighlight">
\[K(x,x')=\sigma(x)\sigma(x')exp(-\frac{|x-x'|^2}{l^2})\]</div>
<p>The prior variance <span class="math notranslate nohighlight">\(\sigma(x)\)</span> is a constant or a spatially varying field, can be self-defined as:</p>
<div class="math notranslate nohighlight">
\[\begin{split}\sigma =
\begin{cases}
&amp; \frac{8}{5}x + 1 \qquad  &amp;x \in [0, 2.5] \\
&amp; -\frac{8}{5}x + 9 \qquad &amp;x \in (2.5, 5]
\end{cases}\end{split}\]</div>
<p>The correction length scale <span class="math notranslate nohighlight">\(l\)</span> is simplified as the rod length in this tutorial.</p>
<p>The orthogonal basis function <span class="math notranslate nohighlight">\(\phi_i(x)\)</span> take the form <span class="math notranslate nohighlight">\(\phi_i(x)=\sqrt{\hat{\lambda_i}}\hat{\phi_i}(x)\)</span>, where <span class="math notranslate nohighlight">\(\hat{lambda_i}\)</span> and <span class="math notranslate nohighlight">\(\hat{\phi_i}(x)\)</span> are the eigenvalues and eigenvectors, respectively, of the kernel :math: <cite>K</cite> computed from the Fredholm integral equation:</p>
<div class="math notranslate nohighlight">
\[\int K(x,x')\hat{\phi(x')dx' = \hat{\lambda}\hat{\phi}(x)\]</div>
<p>Thus we can obtain the diffusivity field through infering the randomized value :math:omega_i based on the observation on temperature.</p>
</div>
<div class="section" id="building-the-dynamic-model">
<h2>Building the Dynamic Model<a class="headerlink" href="#building-the-dynamic-model" title="Permalink to this headline">¶</a></h2>
<p>This is a stationary system, and thus only forward model is concerned. The python script for diffusion model is created in the “source/dyn_models/diffusion.py”</p>
<div class="section" id="diffusion-model-files">
<h3>Diffusion Model Files<a class="headerlink" href="#diffusion-model-files" title="Permalink to this headline">¶</a></h3>
<p>Below is an overview of the files required to run the data assimilation for diffusion model in DA-Inv. The required files are listed below.</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 24%" />
<col style="width: 38%" />
<col style="width: 38%" />
</colgroup>
<tbody>
<tr class="row-odd"><td><p><strong>File Type</strong></p></td>
<td><p><strong>File Name</strong></p></td>
<td><p><strong>Directory</strong></p></td>
</tr>
<tr class="row-even"><td><p>Input File</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">dafi.in</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">/tutorials/diffusion</span></code></p></td>
</tr>
<tr class="row-odd"><td><p>Input File</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">diffusion.in</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">/tutorials/diffusion</span></code></p></td>
</tr>
<tr class="row-even"><td><p>Forward Model</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">diffusion.py</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">/source/dyn_models/</span></code></p></td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="init">
<h3>__init__<a class="headerlink" href="#init" title="Permalink to this headline">¶</a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">init</span></code> function is:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># save the main input</span>
<span class="bp">self</span><span class="o">.</span><span class="n">nsamples</span> <span class="o">=</span> <span class="n">nsamples</span>
<span class="bp">self</span><span class="o">.</span><span class="n">da_interval</span> <span class="o">=</span> <span class="n">da_interval</span>
<span class="bp">self</span><span class="o">.</span><span class="n">t_end</span> <span class="o">=</span> <span class="n">t_end</span>
<span class="bp">self</span><span class="o">.</span><span class="n">max_da_iteration</span> <span class="o">=</span> <span class="n">max_da_iteration</span>

<span class="c1"># read input file</span>
<span class="n">param_dict</span> <span class="o">=</span> <span class="n">read_input_data</span><span class="p">(</span><span class="n">model_input</span><span class="p">)</span>
<span class="bp">self</span><span class="o">.</span><span class="n">x_rel_std</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">param_dict</span><span class="p">[</span><span class="s1">&#39;x_rel_std&#39;</span><span class="p">])</span>
<span class="bp">self</span><span class="o">.</span><span class="n">x_abs_std</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">param_dict</span><span class="p">[</span><span class="s1">&#39;x_abs_std&#39;</span><span class="p">])</span>
<span class="bp">self</span><span class="o">.</span><span class="n">std_coef</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">param_dict</span><span class="p">[</span><span class="s1">&#39;std_coef&#39;</span><span class="p">])</span>
<span class="bp">self</span><span class="o">.</span><span class="n">obs_rel_std</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">param_dict</span><span class="p">[</span><span class="s1">&#39;obs_rel_std&#39;</span><span class="p">])</span>
<span class="bp">self</span><span class="o">.</span><span class="n">obs_abs_std</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">param_dict</span><span class="p">[</span><span class="s1">&#39;obs_abs_std&#39;</span><span class="p">])</span>
<span class="bp">self</span><span class="o">.</span><span class="n">nmodes</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">param_dict</span><span class="p">[</span><span class="s1">&#39;nmodes&#39;</span><span class="p">])</span>
<span class="bp">self</span><span class="o">.</span><span class="n">sigma</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">param_dict</span><span class="p">[</span><span class="s1">&#39;sigma&#39;</span><span class="p">])</span>
<span class="n">mu_init</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">param_dict</span><span class="p">[</span><span class="s1">&#39;mu_init&#39;</span><span class="p">])</span>

<span class="c1"># required attributes</span>
<span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;1D heat diffusion Equation&#39;</span>
<span class="bp">self</span><span class="o">.</span><span class="n">space_interval</span> <span class="o">=</span> <span class="mf">0.1</span>
<span class="bp">self</span><span class="o">.</span><span class="n">max_length</span> <span class="o">=</span> <span class="mi">5</span>
<span class="bp">self</span><span class="o">.</span><span class="n">nstate_obs</span> <span class="o">=</span> <span class="mi">10</span>

<span class="c1"># create spatial coordinate and save</span>
<span class="bp">self</span><span class="o">.</span><span class="n">x_coor</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span>
    <span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_length</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">space_interval</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">space_interval</span><span class="p">)</span>
<span class="n">np</span><span class="o">.</span><span class="n">savetxt</span><span class="p">(</span><span class="s1">&#39;x_coor.dat&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">x_coor</span><span class="p">)</span>

<span class="c1"># initialize state vector</span>
<span class="bp">self</span><span class="o">.</span><span class="n">omega_init</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">nmodes</span><span class="p">))</span>
<span class="bp">self</span><span class="o">.</span><span class="n">init_state</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x_coor</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="bp">self</span><span class="o">.</span><span class="n">augstate_init</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">init_state</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nmodes</span><span class="p">)))</span>
<span class="c1"># dimension of state space</span>
<span class="bp">self</span><span class="o">.</span><span class="n">nstate</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">init_state</span><span class="p">)</span>
<span class="c1"># dimension of augmented state space</span>
<span class="bp">self</span><span class="o">.</span><span class="n">nstate_aug</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">augstate_init</span><span class="p">)</span>

<span class="c1"># create source term fx</span>
<span class="n">S</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nstate</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nstate</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
    <span class="n">S</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">x_coor</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">/</span><span class="mi">5</span><span class="p">)</span>
<span class="n">S</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mat</span><span class="p">(</span><span class="n">S</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
<span class="bp">self</span><span class="o">.</span><span class="n">fx</span> <span class="o">=</span> <span class="n">S</span><span class="o">.</span><span class="n">A</span>

<span class="c1"># create modes for K-L expansion</span>
<span class="n">cov</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">nstate</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nstate</span><span class="p">))</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nstate</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nstate</span><span class="p">):</span>
        <span class="n">cov</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sigma</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">sigma</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span>
            <span class="o">-</span><span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x_coor</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">x_coor</span><span class="p">[</span><span class="n">j</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">max_length</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
<span class="n">eigVals</span><span class="p">,</span> <span class="n">eigVecs</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">eigsh</span><span class="p">(</span><span class="n">cov</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">nmodes</span><span class="p">)</span>
<span class="n">ascendingOrder</span> <span class="o">=</span> <span class="n">eigVals</span><span class="o">.</span><span class="n">argsort</span><span class="p">()</span>
<span class="n">descendingOrder</span> <span class="o">=</span> <span class="n">ascendingOrder</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
<span class="n">eigVals</span> <span class="o">=</span> <span class="n">eigVals</span><span class="p">[</span><span class="n">descendingOrder</span><span class="p">]</span>
<span class="n">eigVecs</span> <span class="o">=</span> <span class="n">eigVecs</span><span class="p">[:,</span> <span class="n">descendingOrder</span><span class="p">]</span>

<span class="c1"># calculate KL modes: eigVec * sqrt(eigVal)</span>
<span class="n">KL_mode_raw</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">nstate</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nmodes</span><span class="p">])</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nmodes</span><span class="p">):</span>
    <span class="n">KL_mode_raw</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">eigVecs</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">eigVals</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
<span class="c1"># normalize the KL modes</span>
<span class="bp">self</span><span class="o">.</span><span class="n">KL_mode</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">nstate</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nmodes</span><span class="p">])</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nmodes</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">KL_mode</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">KL_mode_raw</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span> <span class="o">/</span> \
        <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">KL_mode_raw</span><span class="p">[:,</span> <span class="n">i</span><span class="p">])</span>
<span class="n">np</span><span class="o">.</span><span class="n">savetxt</span><span class="p">(</span><span class="s1">&#39;KLmodes.dat&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">KL_mode</span><span class="p">)</span>

<span class="c1"># project the baseline to KL basis</span>
<span class="n">log_mu_init</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">mu_init</span><span class="p">)]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">nstate</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nmodes</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">omega_init</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">trapz</span><span class="p">(</span>
        <span class="n">log_mu_init</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">KL_mode</span><span class="p">[:,</span> <span class="n">i</span><span class="p">],</span> <span class="n">x</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">x_coor</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">omega_init</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">/=</span> <span class="n">np</span><span class="o">.</span><span class="n">trapz</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">KL_mode</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span>
                                   <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">KL_mode</span><span class="p">[:,</span> <span class="n">i</span><span class="p">],</span> <span class="n">x</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">x_coor</span><span class="p">)</span>
<span class="n">np</span><span class="o">.</span><span class="n">savetxt</span><span class="p">(</span><span class="s1">&#39;omega_init.dat&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">omega_init</span><span class="p">)</span>
</pre></div>
</div>
<p>The inputs to the <code class="docutils literal notranslate"><span class="pre">__init__</span> <span class="pre">method</span></code> is same as for Lorenz tutorial. In this method, we read the input file and get the input file for the diffusion model.</p>
<p>The input file is created as <code class="docutils literal notranslate"><span class="pre">diffusion.in</span></code>. In the input file, we define the required parameters:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>
<span class="c1"># set how many modes to be used</span>
<span class="n">nmodes</span> <span class="mi">3</span>

<span class="c1"># prior diffusivity</span>
<span class="n">mu_init</span> <span class="mf">0.8</span>

<span class="c1"># constant sigma</span>
<span class="n">sigma</span> <span class="mi">5</span>

<span class="c1"># relative and absolute standard deviation for coefficient of KL expansion</span>
<span class="n">x_rel_std</span>  <span class="mf">0.1</span>
<span class="n">x_abs_std</span> <span class="mf">0.8</span>
<span class="n">std_coef</span> <span class="mi">2</span>

<span class="c1"># relative and absolute standard deviation for observation</span>
<span class="n">obs_rel_std</span>      <span class="mf">0.1</span>
<span class="n">obs_abs_std</span>	 <span class="mf">0.0001</span>
</pre></div>
</div>
<p>In the input file, we specify the number of modes and the field variance to represent the field. Then we specify the first guessed constant diffusivity, and the relative and absolute standard deviation to construct a random field. Also, we define the relative and absolute standard deviation for the observation.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>With more modes, we can represent the field more flexiblely. However if the field is a low order curve, the results will lead to worse when introducing too many modes.</p>
</div>
</div>
<div class="section" id="synthetic-observations">
<h3>synthetic observations<a class="headerlink" href="#synthetic-observations" title="Permalink to this headline">¶</a></h3>
<p>We give a synthetic observation on the temperature as:</p>
<div class="math notranslate nohighlight">
\[\mu = 0.5+ 0.02 x^2\]</div>
</div>
</div>
<div class="section" id="running-the-code">
<h2>Running the code<a class="headerlink" href="#running-the-code" title="Permalink to this headline">¶</a></h2>
<p>As in the lorenz tutorial, to run the code first we need source <code class="docutils literal notranslate"><span class="pre">init_da</span></code> file if it has not been done yet. Then we can run the code by following the instruction below.</p>
<p>Specify self-defined parameters in the ‘dafi.in’ file. The ‘dafi.in’ file is provided in the diffusion tutorial directory and shown below.</p>
<p>In this file, we need to specify the number of samples (nsamples) and the maximum data assimilation iteration(max_da_iteration). This case is stationary case, and thus the end time and the data assimilation interval is 1.</p>
<p>Specify self-defined parameters in the ‘diffusion.in’ file. The ‘diffusion.in’ file is provided in the diffusion tutorial directory and shown below.</p>
<p>In this file, we mainly need to specify the number of modes (nmodes), the synthetic true value for each mode coefficent (true_omega) and the relative standard deviation for observation (obs_rel_std)</p>
<p>To execute the data assimilation for diffusion system, move to the directory of ‘$source’</p>
<dl class="simple">
<dt>Then move to the diffusion tutorial directory($tutorials/diffusion), and type code::</dt><dd><p>dafi.py dafi.in</p>
</dd>
</dl>
<p>or the user can also simply type ‘./run.sh’ to run the tutorial. The process information will be saved in ‘log.enkf’ file at diffusion tutorial directory.</p>
<p>‘diffusion_plot.py’ (located in ‘$tutorials/diffusion’) is the postprocessing file to plot the inferred and observed field.</p>
<dl class="simple">
<dt>To execute the postprocessing, type code::</dt><dd><p>./diffusion_plot.py</p>
</dd>
</dl>
<p>to plot figures as shown below. Users can modify the ‘diffusion_plot.py’ for their own post-processing</p>
</div>
<div class="section" id="references">
<h2>References<a class="headerlink" href="#references" title="Permalink to this headline">¶</a></h2>
<p id="bibtex-bibliography-tutorial_diffusion-0"></p>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="source_code.html" class="btn btn-neutral float-right" title="Source Code" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="tutorial_lorenz.html" class="btn btn-neutral float-left" title="Tutorial: Lorenz63" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2018, carlos

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>